---

- block:
    - name: "Install git"
      apt:
        name: git
      become: yes

    - name: "Install pip3"
      shell: curl -sS https://bootstrap.pypa.io/get-pip.py | sudo python3
      args:
        creates: /usr/local/bin/pip3
        warn: no

    - name: "Install Ansible and dependencies"
      pip:
        name:
          - ansible
          - cryptography
          - deepmerge
          - git+git://github.com/Julian/jsonschema.git
          - google-api-python-client
        executable: /usr/local/bin/pip3
        extra_args: --upgrade --user

    - name: "Patch broken GCP module code"
      lineinfile:
        path: /home/ubuntu/.local/lib/python3.5/site-packages/ansible/module_utils/gcp_utils.py
        regexp: self\._credentials\(\)\.with_scopes
        line: "            self._credentials())"
  tags:
    - os_install_ansible
